<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Repair Phone BX</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.js"></script>
    <style>
        :root { --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --primary: #ff5c39; --danger: #ef4444; --success: #34c759; --warning: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        #loginModal { position: fixed; top:0; left:0; width:100%; height:100%; background: #111; display: flex; justify-content: center; align-items: center; z-index: 999; }
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 300px; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; }
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border: none; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666; transition:0.2s; }
        .tab-btn:hover { background: #eee; }
        .tab-btn.active { background: var(--primary); color: white; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none; }
        .res-row { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        @media (min-width: 768px) { .res-row { flex-direction: row; justify-content: space-between; align-items: center; } }
        .res-info strong { display: block; font-size: 16px; margin-bottom: 4px; }
        .res-info small { color: #666; display: block; }
        .status-select { padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-weight: 600; }
        .status-pending { color: var(--warning); } .status-ordered { color: #0071e3; } .status-received { color: #9c27b0; } .status-ready { color: var(--success); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .value { font-size: 32px; font-weight: 700; color: var(--primary); }
        .review-row { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #eee; padding: 15px 0; }
        .btn-delete { background: var(--danger); color: white; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .category-group { background: #f9fafb; border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .category-header { font-weight: 700; color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 18px; }
        .sortable-list { min-height: 50px; padding: 10px; background: white; border-radius: 8px; border: 2px dashed #eee; }
        .product-item-drag { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px; cursor: grab; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.1s; }
        .product-item-drag:active { cursor: grabbing; transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .product-price-input { width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; margin-right: 5px; }
        .add-cat-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-cat-box input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .add-cat-box button { padding: 10px 20px; background: var(--text); color: white; border: none; border-radius: 8px; cursor: pointer; }
        .res-actions { display: flex; gap: 10px; align-items: center; }
        .btn-invoice { background: #0071e3; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .btn-delete-res { background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>
    <div id="loginModal"><div class="login-box"><h2>üîê Acc√®s Admin</h2><input type="password" id="passwordInput" placeholder="Mot de passe secret"><button onclick="login()">Entrer</button><p id="errorMsg" style="color:red; font-size:12px; display:none; margin-top:10px;">Mot de passe incorrect</p></div></div>
    <div id="dashboard" class="hidden"><div class="header"><h1>üìä Dashboard Pro</h1><button onclick="location.reload()" style="background:white; border:1px solid #ddd; padding:5px 10px; border-radius:5px; cursor:pointer;">üîÑ Actualiser</button></div><div class="tabs"><button class="tab-btn active" onclick="switchTab('reservations', this)">Gestion R√©servations</button><button class="tab-btn" onclick="switchTab('stats', this)">üìä Stats</button><button class="tab-btn" onclick="switchTab('products', this)">üì¶ Produits & Cat√©gories</button><button class="tab-btn" onclick="switchTab('reviews', this)">üõ°Ô∏è Avis</button></div>
        
        <div id="tab-reservations"><div class="card"><h3>Derni√®res Commandes (Pay√©es)</h3><div id="reservations-list">Chargement...</div></div></div>
        <div id="tab-stats" class="hidden"><div class="kpi-grid"><div class="card"><h3>Visites Aujourd'hui</h3><div class="value" id="val-today">0</div></div><div class="card"><h3>Visites Totales</h3><div class="value" id="val-total">0</div></div></div><div class="card"><h3>D√©tails (Appareils & Clics)</h3><ul id="stats-details-list" style="padding-left:20px; line-height:1.8; color:#555;"></ul></div></div>
        <div id="tab-products" class="hidden"><div class="card"><h3>Gestion des Prix & Cat√©gories</h3><p style="color:#666; font-size:14px; margin-bottom:20px;">üí° Astuce : Glissez les produits d'une cat√©gorie √† l'autre pour les d√©placer. Cr√©ez des cat√©gories pour No√´l, Black Friday, etc.</p><div class="add-cat-box"><input type="text" id="newCatInput" placeholder="Nom de la nouvelle cat√©gorie (ex: NOEL, BLACKFRIDAY...)"><button onclick="addNewCategory()">Cr√©er Cat√©gorie</button></div><div id="categories-container">Chargement...</div></div></div>
        <div id="tab-reviews" class="hidden"><div class="card"><h3>Mod√©ration Avis</h3><div id="reviews-list">Chargement...</div></div></div>
    </div>

    <script>
        let token = null; let allReservations = [];
        async function login() { const pass = document.getElementById('passwordInput').value; const res = await fetch('/api/admin/stats', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pass }) }); if (res.ok) { token = pass; localStorage.setItem('isAdminBrowser', 'true'); document.getElementById('loginModal').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; const data = await res.json(); renderStats(data); renderReviews(data.reviews); loadProducts(); loadReservations(); } else { document.getElementById('errorMsg').style.display = 'block'; } }
        function switchTab(tabId, btn) { document.querySelectorAll('[id^="tab-"]').forEach(d => d.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab-' + tabId).classList.remove('hidden'); btn.classList.add('active'); }
        function renderStats(data) { document.getElementById('val-total').innerText = data.total; document.getElementById('val-today').innerText = data.today; const list = document.getElementById('stats-details-list'); list.innerHTML = ''; if(data.devices) data.devices.forEach(d => list.innerHTML += `<li>üì± ${d.device}: <b>${d.count}</b></li>`); if(data.clicks) data.clicks.forEach(c => list.innerHTML += `<li>üëÜ Clic sur "${c.target}": <b>${c.count}</b></li>`); }
        function renderReviews(reviews) { const container = document.getElementById('reviews-list'); container.innerHTML = ''; if(!reviews || reviews.length === 0) return container.innerHTML = '<p>Aucun avis.</p>'; reviews.forEach(r => { container.innerHTML += `<div class="review-row" id="review-${r.id}"><div><strong>${r.author}</strong> ${'‚≠ê'.repeat(r.rating)}<br><small>${r.content}</small></div><button class="btn-delete" onclick="deleteReview(${r.id})">Supprimer</button></div>`; }); }

        async function loadReservations() {
            const res = await fetch('/api/admin/reservations?password=' + token);
            allReservations = await res.json();
            const container = document.getElementById('reservations-list');
            container.innerHTML = ''; 
            if(allReservations.length === 0) return container.innerHTML = '<p>Aucune commande r√©cente.</p>';
            
            allReservations.forEach(r => {
                const isFinished = (r.status === 'finished');
                const actionButtons = isFinished ? `<button class="btn-invoice" onclick="generatePDF(${r.id})">üìÑ Facture</button><button class="btn-delete-res" onclick="deleteReservation(${r.id})">üóëÔ∏è Supprimer</button>` : '';
                container.innerHTML += `<div class="res-row" id="res-${r.id}"><div class="res-info"><strong>${r.client_name}</strong><small>${r.service_type} | ${r.date}</small><small>Code: <b>${r.tracking_code || 'N/A'}</b> | Pay√©: ${r.amount_paid}‚Ç¨</small></div><div class="res-actions"><select class="status-select status-${r.status}" onchange="updateStatus(${r.id}, this.value)"><option value="pending" ${r.status==='pending'?'selected':''}>‚è≥ En attente</option><option value="ordered" ${r.status==='ordered'?'selected':''}>üöö Command√©</option><option value="received" ${r.status==='received'?'selected':''}>üì¶ Re√ßu</option><option value="ready" ${r.status==='ready'?'selected':''}>‚úÖ Pr√™t</option><option value="finished" ${r.status==='finished'?'selected':''}>üÜó R√©cup√©r√© (Fini)</option></select>${actionButtons}</div></div>`;
            });
        }

        // --- CORRECTION DE LA FONCTION DE SUPPRESSION (AJOUT DE /api) ---
        async function deleteReservation(id) {
            if(!confirm("Supprimer cette commande D√âFINITIVEMENT ?")) return;
            const res = await fetch(`/api/admin/reservations/${id}`, { 
                method: 'DELETE', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ password: token }) 
            });
            if(res.ok) { document.getElementById('res-' + id).remove(); } else { alert("Erreur suppression"); }
        }

        function generatePDF(resId) {
            const r = allReservations.find(res => res.id === resId);
            if(!r) return alert("Erreur: commande introuvable");
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFontSize(22); doc.setTextColor(255, 92, 57); doc.text("Repair Phone BX", 20, 20); doc.setFontSize(10); doc.setTextColor(100); doc.text("Ribaucourt, 1080 Molenbeek-Saint-Jean", 20, 28); doc.text("T√©l: 0467 79 17 37", 20, 33);
            doc.setFontSize(16); doc.setTextColor(0); doc.text(`FACTURE N¬∞ ${r.tracking_code || r.id}`, 140, 20); doc.setFontSize(10); doc.text(`Date: ${new Date().toLocaleDateString()}`, 140, 28);
            doc.setDrawColor(200); doc.line(20, 45, 190, 45); doc.setFontSize(12); doc.text("Client :", 20, 55); doc.setFontSize(10); doc.text(r.client_name, 20, 62); doc.text(r.email, 20, 67); doc.text(r.phone, 20, 72);
            doc.autoTable({ startY: 85, head: [['Description', 'Montant']], body: [[r.service_type, r.total_price + " ‚Ç¨"], ['Acompte vers√© en ligne', '-' + r.amount_paid + " ‚Ç¨"],], theme: 'striped', headStyles: { fillColor: [255, 92, 57] } });
            const finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(12); doc.text(`Reste √† payer / Pay√© sur place : ${r.total_price - r.amount_paid} ‚Ç¨`, 120, finalY); doc.setFontSize(14); doc.setTextColor(255, 92, 57); doc.text(`TOTAL : ${r.total_price} ‚Ç¨`, 120, finalY + 10);
            doc.setDrawColor(200); doc.line(20, finalY + 30, 190, finalY + 30); doc.setFontSize(9); doc.setTextColor(100); doc.text("Garantie de 6 mois sur la pi√®ce remplac√©e (hors casse, oxydation ou mauvaise utilisation).", 20, finalY + 40); doc.text("Merci pour votre confiance !", 20, finalY + 45);
            doc.save(`facture_repairphonebx_${r.id}.pdf`);
        }

        let allProducts = []; let sortables = [];
        async function loadProducts() { const container = document.getElementById('categories-container'); try { const res = await fetch('/api/products'); allProducts = await res.json(); container.innerHTML = ''; const categories = {}; allProducts.forEach(p => { if(!categories[p.category]) categories[p.category] = []; categories[p.category].push(p); }); for(const cat in categories) { createCategoryBlock(cat, categories[cat]); } initSortables(); } catch(e) { container.innerHTML = "Erreur chargement produits."; } }
        function createCategoryBlock(catName, products = []) { const container = document.getElementById('categories-container'); const catDiv = document.createElement('div'); catDiv.className = 'category-group'; catDiv.innerHTML = `<div class="category-header">${catName}</div>`; const list = document.createElement('div'); list.className = 'sortable-list'; list.dataset.category = catName; products.forEach(p => { const prodDiv = document.createElement('div'); prodDiv.className = 'product-item-drag'; prodDiv.dataset.id = p.id; prodDiv.innerHTML = `<span>Now: <b>${p.category}</b> - ${p.model}</span><div><input type="number" value="${p.price}" class="product-price-input" id="price-${p.id}"><button style="background:#34c759; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;" onclick="updatePrice(${p.id}, event)">OK</button></div>`; list.appendChild(prodDiv); }); catDiv.appendChild(list); container.appendChild(catDiv); }
        function initSortables() { sortables.forEach(s => s.destroy()); sortables = []; document.querySelectorAll('.sortable-list').forEach(list => { const sortable = new Sortable(list, { group: 'shared', animation: 150, ghostClass: 'bg-blue-100', onEnd: async function (evt) { const productId = evt.item.dataset.id; const newCategory = evt.to.dataset.category; const oldCategory = evt.from.dataset.category; if(newCategory !== oldCategory) { await fetch(`/api/admin/products/${productId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: token, category: newCategory }) }); evt.item.querySelector('span b').innerText = newCategory; } } }); sortables.push(sortable); }); }
        function addNewCategory() { const input = document.getElementById('newCatInput'); const catName = input.value.trim().toUpperCase(); if(!catName) return alert("Entrez un nom"); if(document.querySelector(`.sortable-list[data-category="${catName}"]`)) return alert("Cette cat√©gorie existe d√©j√†"); createCategoryBlock(catName, []); initSortables(); input.value = ''; }
        async function updatePrice(id, event) { event.stopPropagation(); const newPrice = document.getElementById(`price-${id}`).value; const res = await fetch(`/api/admin/products/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: token, price: newPrice }) }); if(res.ok) alert("Prix mis √† jour !"); }
        async function deleteReview(id) { if(!confirm("Supprimer ?")) return; const res = await fetch('/reviews/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: token }) }); if(res.ok) { document.getElementById('review-' + id).remove(); } }
        async function updateStatus(id, newStatus) { const res = await fetch(`/api/admin/reservations/${id}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: token, status: newStatus }) }); if(res.ok) { alert("Statut mis √† jour !"); loadReservations(); } }
    </script>
</body>
</html>